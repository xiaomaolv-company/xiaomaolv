<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小毛驴</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://as.alipayobjects.com/g/component/fastclick/1.0.6/fastclick.js"></script>
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1539720_d5qe7eiscjj.css">
</head>
<body id="body">
<div id="root"></div>
</body>
<script>
  window.onload = function () {

    /**
     * 获取URL中的参数
     * @param key 参数的key
     * @returns {any}
     */
    function getUrlParam(key) {
      var reg = new RegExp(key + '=([^&]*)');
      var results = location.search.match(reg);
      return results ? results[1] : null;
    }

    if (!getUrlParam("code")) { // 此处做判断的原因是会不停的跳转至授权免登页面
      window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa71ab380527ceb2a&redirect_uri=http://172.81.203.18&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect'
    } else {
      $.ajax({
        url: 'http://172.81.203.18/wechatlogin/app/userLogin',
        headers: {
          code: getUrlParam("code")
        },
        type: "get",
        success: function (data) {
          if (data) {
            const {statusCode, appData, message} = data;
            if (statusCode === 1) { // 登录验证成功
              window.sessionStorage.setItem("loginUserInfo", appData.user);
              let script = document.createElement("script");
              script.src = "./main.bundle.js";
              document.getElementById("body").appendChild(script);
            } else {
              alert(message);
            }
          } else {
            alert("登录验证失败！");
          }
        }
      });
    }

  };


  if ('addEventListener' in document) {
    document.addEventListener('DOMContentLoaded', function () {
      FastClick.attach(document.body);
    }, false);
  }
  if (!window.Promise) {
    document.writeln('<script src="https://as.alipayobjects.com/g/component/es6-promise/3.2.2/es6-promise.min.js"' + '>' + '<' + '/' + 'script>');
  }
</script>
</html>